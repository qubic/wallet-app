# .github/workflows/flutter.yml

name: CI Main Workflow

on:
  push:
    branches:
      - feature/ci # to remove after testing is ok
      - develop
      - release/*
      - hotfix/*
  pull_request:
    branches:
      - "*"

jobs:
  analyze:
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì∂ Set up Flutter
        uses: ./.github/actions/setup-flutter

      - name: üìÖ Cache Flutter pub packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: üìÅ Install dependencies
        run: flutter pub get

      - name: üìä Analyze code
        run: flutter analyze

      # - name: üåê Run tests
      #   run: flutter test

  build_ios:
    name: Build iOS Application
    needs: analyze
    if: github.event_name == 'pushABC'
    uses: ./.github/workflows/ios.yml
    secrets:
      APP_STORE_KEY_ID: ${{ secrets.APP_STORE_KEY_ID }}
      APP_STORE_API_KEY: ${{ secrets.APP_STORE_API_KEY }}
      APP_STORE_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      TEMP_KEYCHAIN_PASSWORD: ${{ secrets.TEMP_KEYCHAIN_PASSWORD }}

  build_android:
    name: Build Android Application
    needs: analyze
    if: github.event_name == 'push'
    uses: ./.github/workflows/firebase-app-distribution.yml
    secrets:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
      FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
